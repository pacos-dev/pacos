DROP TABLE IF EXISTS APP_PERMISSION_USER;
DROP TABLE IF EXISTS APP_PERMISSION_DEF;
DROP TABLE IF EXISTS APP_ROLE_PERMISSION;
DROP TABLE IF EXISTS APP_ROLE_USER;
DROP TABLE IF EXISTS APP_ROLE;
DROP TABLE IF EXISTS APP_PERMISSION;

CREATE SEQUENCE if not exists APP_PERMISSION_SEQ START WITH 1 INCREMENT BY 1;
CREATE TABLE if not exists APP_PERMISSION
(
    id          INTEGER GENERATED BY DEFAULT AS SEQUENCE APP_PERMISSION_SEQ PRIMARY KEY not null,
    key         VARCHAR(255),
    label       VARCHAR(255),
    category    VARCHAR(255),
    description VARCHAR(2000),
    UNIQUE (key)
);

CREATE SEQUENCE if not exists APP_ROLE_SEQ START WITH 3 INCREMENT BY 1;
CREATE TABLE if not exists APP_ROLE
(
    id          INTEGER GENERATED BY DEFAULT AS SEQUENCE APP_ROLE_SEQ PRIMARY KEY not null,
    label       VARCHAR(255),
    description VARCHAR(2000),
    UNIQUE (label)
);

CREATE TABLE if not exists APP_ROLE_PERMISSION
(
    role_id       INTEGER NOT NULL REFERENCES APP_ROLE (id) ON DELETE CASCADE,
    permission_id INTEGER NOT NULL REFERENCES APP_PERMISSION (id) ON DELETE CASCADE,
    PRIMARY KEY (role_id, permission_id)
);


CREATE SEQUENCE if not exists APP_ROLE_USER_SEQ START WITH 1 INCREMENT BY 1;
CREATE TABLE if not exists APP_ROLE_USER
(
    user_id INTEGER NOT NULL REFERENCES APP_USER (id) ON DELETE CASCADE,
    role_id INTEGER NOT NULL REFERENCES APP_ROLE (id) ON DELETE CASCADE,
    UNIQUE (user_id, role_id)
);

INSERT INTO APP_ROLE(ID, LABEL, DESCRIPTION)
VALUES (1, 'ROLE_GUEST', 'Role that by default is assigned to all guest sessions (if guest session is enabled)');
INSERT INTO APP_ROLE(ID, LABEL, DESCRIPTION)
VALUES (2, 'ROLE_ROOT', 'Role that by default always have all permissions assigned');

INSERT INTO APP_ROLE_USER (USER_ID, ROLE_ID)
SELECT 1, 1
FROM (VALUES (0))
WHERE EXISTS (SELECT 1 FROM APP_USER WHERE ID = 1);

INSERT INTO APP_ROLE_USER (USER_ID, ROLE_ID)
SELECT 2, 2
FROM (VALUES (0))
WHERE EXISTS (SELECT 1 FROM APP_USER WHERE ID = 2);